<component>
    <name>alfrescovalidations</name>
    <description>Alfresco Validations</description>
    <detailedDescription></detailedDescription>
    <selected>1</selected>
    <show>0</show>
    <functionDefinitionList>
        <actionDefinition name="alfrescoComponentsValidations">
            <actionList>
                <throwError>
                    <text>You need to select at least one of the Solr components</text>
                    <ruleList>
                        <componentTest name="alfrescosolr4" logic="not_selected"/>
                        <componentTest name="alfrescosolr" logic="not_selected"/>
                    </ruleList>
                </throwError>
                <alfrescoAutodetectJava javaRequiredOrAbort="1" javaRequiredJdk="1" alfrescoInstallerBitness="${alfresco_installer_bitness}">
                    <ruleList>
                        <isFalse value="${component(javaalfresco).selected}" />
                    </ruleList>
                </alfrescoAutodetectJava>
            </actionList>
        </actionDefinition>
        <actionDefinition name="alfrescoSystemValidations">
            <actionList>
                <setInstallerVariable name="reportValue" value=""/>
                <setInstallerVariable name="msgArchitectureWarning" value="${tr('64bit architecture recommended')}"/>
                <setInstallerVariable name="msgCpuSpeed" value="${tr('Insufficient CPU clock speed')}"/>
                <setInstallerVariable name="msgCpuCores" value="${tr('Insufficient CPUs (cores)')}"/>
                <setInstallerVariable name="msgRam" value="${tr('Insufficient system RAM')}"/>
                <setInstallerVariable name="msgFileDescriptors" value="${tr('Insufficent file descriptors')}"/>
                <setInstallerVariable name="msgCifsUdp" value="${tr('CIFS UDP ports in use')}"/>
                <setInstallerVariable name="msgCifsTcp" value="${tr('CIFS TCP ports in use')}"/>
                <setInstallerVariable name="msgSmtpTcp" value="${tr('SMTP TCP port in use')}"/>
                <setInstallerVariable name="msgImapTcp" value="${tr('IMAP TCP port in use')}"/>
                <throwError>
                    <text>This installer is for Windows 64 bit.  Please download the Windows 32 bit version.</text>
                    <ruleList>
                        <compareText text="${project.installerFilename}" logic="contains" value="win-x64"/>
                        <platformTest type="windows"/>
                        <platformTest type="windows-x64" negate="1"/>
                    </ruleList>
                </throwError>
                <setInstallerVariable name="reportValue" value="${reportValue}${msgArchitectureWarning}: 32bit&#xA;">
                    <ruleList>
                        <compareText text="${project.installerFilename}" logic="does_not_contain" value="win-x64"/>
                        <platformTest type="windows-x64"/>
                    </ruleList>
                </setInstallerVariable>
                <!-- Server Hardware -->
                <!-- CPU Speed validation -->
                <mathExpression text="int(ceil(${machine_cpu_speed}/1000))" variable="machine_cpu_speedGHz"/>
                <mathExpression text="int(ceil(${minimum_cpu_speed}/1000))" variable="minimum_cpu_speedGHz"/>
                <mathExpression text="int(ceil(${recommended_cpu_speed}/1000))" variable="recommended_cpu_speedGHz"/>
                <throwError>
                    <text>CPU clock speed of ${machine_cpu_speedGHz} GHz is slower than the minimum required by Alfresco (${minimum_cpu_speedGHz} GHz). Alfresco will not perform well. Upgrade the server to one with more modern CPUs (CPU clock speed of at least ${minimum_cpu_speedGHz} GHz, and preferably ${recommended_cpu_speedGHz} GHz or more).</text>
                    <ruleList>
                        <compareValues>
                            <logic>less</logic>
                            <value1>${machine_cpu_speed}</value1>
                            <value2>${minimum_cpu_speed}</value2>
                        </compareValues>
                    </ruleList>
                </throwError>
                <setInstallerVariable name="reportValue" value="${reportValue}${msgCpuSpeed} (${recommended_cpu_speedGHz} GHz+): ${machine_cpu_speedGHz} GHz&#xA;">
                    <ruleList>
                        <compareValues>
                            <logic>less</logic>
                            <value1>${machine_cpu_speed}</value1>
                            <value2>${recommended_cpu_speed}</value2>
                        </compareValues>
                        <compareValues>
                            <logic>greater_or_equal</logic>
                            <value1>${machine_cpu_speed}</value1>
                            <value2>${minimum_cpu_speed}</value2>
                        </compareValues>
                    </ruleList>
                </setInstallerVariable>
                <!-- CPU Cores validation -->
                <setInstallerVariable name="reportValue" value="${reportValue}${msgCpuCores} (${minimum_core_count}+): ${machine_cpu_count}&#xA;">
                    <ruleList>
                        <compareValues>
                            <logic>less</logic>
                            <value1>${machine_cpu_count}</value1>
                            <value2>${minimum_core_count}</value2>
                        </compareValues>
                    </ruleList>
                </setInstallerVariable>
                <!-- RAM validation -->
                <mathExpression text="int(ceil(${machine_total_memory}/1024))" variable="machine_total_memoryGB"/>
                <mathExpression text="int(ceil(${minimum_ram}/1024))" variable="minimum_ramGB"/>
                <mathExpression text="int(ceil(${recommended_ram}/1024))" variable="recommended_ramGB"/>
                <throwError>
                    <text>${machine_total_memoryGB} GB of RAM is not enough to run Alfresco for test or production purposes. Alfresco may not function correctly and if it does, it will not perform well. Upgrade the server to have at least ${minimum_ramGB} GB of RAM (preferably at least ${recommended_ramGB} GB).</text>
                    <ruleList>
                        <compareValues>
                            <logic>less</logic>
                            <value1>${machine_total_memory}</value1>
                            <value2>${minimum_ram}</value2>
                        </compareValues>
                    </ruleList>
                </throwError>
                <setInstallerVariable name="reportValue" value="${reportValue}${msgRam} (${recommended_ramGB}GB+): ${machine_total_memoryGB}GB">
                    <ruleList>
                        <compareValues>
                            <logic>less</logic>
                            <value1>${machine_total_memory}</value1>
                            <value2>${recommended_ram}</value2>
                        </compareValues>
                        <compareValues>
                            <logic>greater_or_equal</logic>
                            <value1>${machine_total_memory}</value1>
                            <value2>${minimum_ram}</value2>
                        </compareValues>
                    </ruleList>
                </setInstallerVariable>
                <!-- File Descriptors validation-->
                <setInstallerVariable name="reportValue" value="${reportValue}${msgFileDescriptors} (${minimum_file_descriptors}+)">
                    <ruleList>
                        <resourceLimitTest type="open_files" logic="less" value="${minimum_file_descriptors}"/>
                        <platformTest type="windows" negate="1"/>
                    </ruleList>
                </setInstallerVariable>

                <!-- Network validation -->
                <actionGroup>
                    <actionList>
                        <!-- Validate CIFS ports -->
                        <setInstallerVariable name="cifsUdpPortList" value=""/>
                        <foreach variables="cifs_udp_port_to_check">
                            <values>${netbd_port}, ${netbd_port_1}</values>
                            <actionList>
                                <setInstallerVariable name="cifsUdpPortList" value="${cifsUdpPortList} ${cifs_udp_port_to_check}">
                                    <ruleList>
                                        <portTest port="${cifs_udp_port_to_check}" condition="cannot_bind"/>
                                        <platformTest  type="windows" negate="1"/>
                                    </ruleList>
                                </setInstallerVariable>
                            </actionList>
                        </foreach>
                        <setInstallerVariable name="reportValue" value="${reportValue}${msgCifsUdp}: ${cifsUdpPortList}&#xA;">
                            <ruleList>
                                <compareText text="${cifsUdpPortList}" logic="does_not_equal" value=""/>
                            </ruleList>
                        </setInstallerVariable>
                        <setInstallerVariable name="cifsTcpPortList" value=""/>
                        <foreach variables="cifs_tcp_port_to_check">
                            <values>${netbd_port}, ${netbd_port_2}, ${smb_port}</values>
                            <actionList>
                                <setInstallerVariable name="cifsTcpPortList" value="${cifsTcpPortList} ${cifs_tcp_port_to_check}">
                                    <ruleList>
                                        <portTest port="${cifs_tcp_port_to_check}" condition="cannot_bind"/>
                                        <platformTest  type="windows" negate="1"/>
                                    </ruleList>
                                </setInstallerVariable>
                            </actionList>
                        </foreach>
                        <setInstallerVariable name="reportValue" value="${reportValue}${msgCifsTcp}: ${cifsTcpPortList}&#xA;">
                            <ruleList>
                                <compareText text="${cifsTcpPortList}" logic="does_not_equal" value=""/>
                            </ruleList>
                        </setInstallerVariable>
                        <setInstallerVariable name="reportValue" value="${reportValue}${msgSmtpTcp}: ${smtp_port}&#xA;">
                            <ruleList>
                                <portTest port="${smtp_port}" condition="cannot_bind"/>
                            </ruleList>               
                        </setInstallerVariable>
                        <setInstallerVariable name="reportValue" value="${reportValue}${msgImapTcp}: ${smtp_port}&#xA;">
                            <ruleList>
                                <portTest port="${imap_port}" condition="cannot_bind"/>
                            </ruleList>
                        </setInstallerVariable>
                    </actionList>
                    <ruleList>
                        <isTrue value="${installer_is_root_install}"/>
                    </ruleList>
                </actionGroup>
                <setInstallerVariable name="component(alfrescovalidations).parameter(alfresco_report).value" value="${reportValue}">
                    <ruleList>
                        <compareText text="${reportValue}" value="" logic="does_not_equal"/>
                    </ruleList>
                </setInstallerVariable>
                <setInstallerVariable name="component(alfrescovalidations).parameter(alfresco_report).ask" value="0">
                    <ruleList>
                        <compareText text="${reportValue}" value="" logic="equals"/>
                    </ruleList>
                </setInstallerVariable>
            </actionList>
        </actionDefinition>
    </functionDefinitionList>
    <componentSelectionValidationActionList>
        <alfrescoComponentsValidations/>
    </componentSelectionValidationActionList>
    <desktopShortcutList/>
    <parameterList>
        <stringParameter name="recommended_cpu_speed" value="2500" ask="0"/>
        <stringParameter name="minimum_cpu_speed" value="1200" ask="0"/>
        <stringParameter name="minimum_core_count" value="2" ask="0"/>
        <stringParameter name="recommended_ram" value="4096" ask="0"/>
        <stringParameter name="minimum_ram" value="512" ask="0"/>
        <stringParameter name="minimum_file_descriptors" value="4096" ask="0"/>
        <parameterGroup>
            <name>netbd_ports</name>
            <title>CIFS protocol ports configuration</title>
            <explanation>Please, enter CIFS ports configuration</explanation>
            <ask>0</ask>
            <parameterList>
                <stringParameter name="netbd_port" default="137" ask="0">
                    <title>CIFS server port</title>
                </stringParameter>
                <stringParameter name="netbd_port_1" default="138" ask="0">
                    <title>CIFS server port 1</title>
                </stringParameter>
                <stringParameter name="netbd_port_2" default="139" ask="0">
                    <title>CIFS server port 2</title>
                </stringParameter>
                <stringParameter name="smb_port" value="445" ask="0">
                    <title>SMB port</title>
                </stringParameter>
            </parameterList>
        </parameterGroup>
        <stringParameter name="smtp_port" value="25" ask="0">
            <description>SMTP port</description>
        </stringParameter>
        <stringParameter name="imap_port" value="143" ask="0">
            <description>IMAP port</description>
        </stringParameter>
        <infoParameter>
            <name>alfresco_report</name>
            <title>Warning!</title>
            <explanation>This environment is not configured optimally for Alfresco - please carefully review this list before continuing.

While these issues will not prevent Alfresco from functioning, some product features may be unavailable, or the system may not perform optimally.</explanation>
            <value></value>
            <insertBefore>readytoinstall</insertBefore>
        </infoParameter>
    </parameterList>
    <readyToInstallActionList/>
    <preInstallationActionList>
        <alfrescoSystemValidations/>
        <alfrescoComponentsValidations>
            <ruleList>
                <compareText text="${installer_ui}" logic="equals" value="unattended"/>
            </ruleList>
        </alfrescoComponentsValidations>
    </preInstallationActionList>
</component>

