import:
  - source: travis-env-vars.yml
os: linux
dist: xenial
language: java
jdk:
  - openjdk8

branches:
  only:
    - /release\/V2.7.*/
    - /feature-2.7\/.*/
    - /merge-2.7\/.*/
    - /hotfix-2.7\/.*/

cache:
  directories:
    - $HOME/.m2

# the cache can grow constantly
before_cache:
  - rm -rf $HOME/.m2/repository/org/alfresco/alfresco-rm*

before_install:
  - "cp .travis.settings.xml $HOME/.m2/settings.xml"
install: skip

services:
  - xvfb
  - docker

env:
  matrix:
    - TEST_SUITE=enterpriseLevel2Tests.xml
    - TEST_SUITE=enterpriseLevel2ClassificationTests.xml
    - TEST_SUITE=enterpriseClassificationTests.xml
    - TEST_SUITE=enterpriseGuidesTests.xml
    - TEST_SUITE=enterpriseSecurityMarksTests.xml
    - TEST_SUITE=enterpriseConsoleAndConfigurationTests.xml

stages:
#  - name: Build AGS
  - name: Tests
    if: commit_message !~ /\[skip tests\]/
  - name: Security Scans
  - name: Release
  - name: Publish

jobs:
  include:
#    - name: "Build AGS Community"
#      stage: Build AGS
#      before_script: source scripts/setUpMavenPhase.sh
#      script:
#        - travis_retry travis_wait 80 mvn -B -q clean ${MAVEN_PHASE} -Dskip.integrationtests=false -Dcommunity -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn
#
#    - name: "Build AGS Enterprise"
#      stage: Build AGS
#      before_script: source scripts/setUpMavenPhase.sh
#      install:
#        - travis_retry travis_wait 60 mvn -B -q clean install -DskipTests -Dmaven.javadoc.skip=true -Dmaven.source.skip=true -f rm-community/pom.xml -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn
#      script:
#        - travis_retry travis_wait 80 mvn -B -q clean ${MAVEN_PHASE} -Dskip.integrationtests=false -f rm-enterprise/pom.xml -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn
#
#    - name: "Build AGS Benchmark"
#      stage: Build AGS
#      before_script: source scripts/setUpMavenPhase.sh
#      install:
#        - travis_retry travis_wait 60 mvn -B -q clean install -DskipTests -Dmaven.javadoc.skip=true -Dmaven.source.skip=true -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn
#      script:
#        - travis_retry travis_wait 35 mvn -B -q clean ${MAVEN_PHASE} -Dskip.integrationtests=false -f rm-benchmark/pom.xml -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn
#
#    - name: "Community Integrations Tests on MySQL"
#      stage: Tests
#      script:
#        - echo "Community Integrations Tests on MySQL"
#    - name: "Enterprise Integrations Tests on MySQL"
#      stage: Tests
#      script:
#        - echo "Enterprise Integrations Tests on MySQL"

    - name: "Community Rest API Tests"
      stage: Tests
      env: # no environment variables - overwrite with empty
      before_install:
        - travis_retry travis_wait 90 mvn -B install -Dmaven.javadoc.skip=true -Dmaven.source.skip=true -DskipTests -q
        - travis_wait 5 bash scripts/downloadInstaller.sh $AUTOMATION_COMMUNITY_PATH/target
      install: travis_wait 20 mvn -B install -PinstallAlfresco,apply-rm-community -q -f $AUTOMATION_COMMUNITY_PATH/pom.xml
      script:
        - travis_wait 60 mvn -B install -Prun-alfresco -Dskip.automationtests=false -f $AUTOMATION_COMMUNITY_PATH/pom.xml -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn

    - name: "Enterprise Rest API Tests"
      stage: Tests
      env: # no environment variables - overwrite with empty
      before_install:
        - travis_retry travis_wait 90 mvn -B install -Dmaven.javadoc.skip=true -Dmaven.source.skip=true -DskipTests -q
        - travis_wait 5 bash scripts/downloadInstaller.sh $AUTOMATION_ENTERPRISE_PATH/target
      install: travis_wait 20 mvn -B install -PinstallAlfresco,apply-rm-enterprise -q -f $AUTOMATION_ENTERPRISE_PATH/pom.xml
      script:
        - travis_wait 60 mvn -B install -Prun-alfresco -Dskip.automationtests=false -f $AUTOMATION_ENTERPRISE_PATH/pom.xml -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn

    - name: "Community Smoke UI Tests for In place Records"
      stage: Tests
      env: # no environment variables - overwrite with empty
      addons:
        firefox: "43.0.1"
        artifacts:
          paths:
            - ./rm-automation/rm-automation-ui/target/surefire-reports
            - ./rm-automation/rm-automation-ui/target/reports
            - ./rm-automation/rm-automation-ui/target/screenshots
          target_paths: $TRAVIS_BUILD_NUMBER
      before_install:
        - travis_retry travis_wait 90 mvn -B install -Dmaven.javadoc.skip=true -Dmaven.source.skip=true -DskipTests -q
        - travis_wait 5 bash scripts/downloadInstaller.sh $AUTOMATION_UI_PATH/target
      install: travis_wait 20 mvn -B install -PinstallAlfresco,apply-rm-community -q -f $AUTOMATION_UI_PATH/pom.xml
      script:
        - travis_wait 60 mvn -B test -Prun-alfresco -Dskip.automationtests=false -f $AUTOMATION_UI_PATH/pom.xml -DsuiteXmlFile=communitySmokeInPlaceRecords.xml -Dshare.url=${SHARE_URL} -Dalfresco.url=${ALFRESCO_URL} ${WEBDRIVER_ARGUMENTS}

    - name: "Community Smoke UI Tests for actions in RM site"
      stage: Tests
      env: # no environment variables - overwrite with empty
      addons:
        firefox: "43.0.1"
        artifacts:
          paths:
            - ./rm-automation/rm-automation-ui/target/surefire-reports
            - ./rm-automation/rm-automation-ui/target/reports
            - ./rm-automation/rm-automation-ui/target/screenshots
          target_paths: $TRAVIS_BUILD_NUMBER
      before_install:
        - travis_retry travis_wait 90 mvn -B install -Dmaven.javadoc.skip=true -Dmaven.source.skip=true -DskipTests -q
        - travis_wait 5 bash scripts/downloadInstaller.sh $AUTOMATION_UI_PATH/target
      install: travis_wait 20 mvn -B install -PinstallAlfresco,apply-rm-community -q -f $AUTOMATION_UI_PATH/pom.xml
      script:
        - travis_wait 60 mvn -B install -Prun-alfresco -Dskip.automationtests=false -f $AUTOMATION_UI_PATH/pom.xml -DsuiteXmlFile=communitySmokeRMSite.xml -Dshare.url=${SHARE_URL} -Dalfresco.url=${ALFRESCO_URL} ${WEBDRIVER_ARGUMENTS}

    - name: "Community Level 2 UI Tests"
      stage: Tests
      env: # no environment variables - overwrite with empty
      addons:
        firefox: "43.0.1"
        artifacts:
          paths:
            - ./rm-automation/rm-automation-ui/target/surefire-reports
            - ./rm-automation/rm-automation-ui/target/reports
            - ./rm-automation/rm-automation-ui/target/screenshots
          target_paths: $TRAVIS_BUILD_NUMBER
      before_install:
        - travis_retry travis_wait 90 mvn -B install -Dmaven.javadoc.skip=true -Dmaven.source.skip=true -DskipTests -q
        - travis_wait 5 bash scripts/downloadInstaller.sh $AUTOMATION_UI_PATH/target
      install: travis_wait 20 mvn -B install -PinstallAlfresco,apply-rm-community -q -f $AUTOMATION_UI_PATH/pom.xml
      script:
        - travis_wait 60 mvn -B install -Prun-alfresco -Dskip.automationtests=false -f $AUTOMATION_UI_PATH/pom.xml -DsuiteXmlFile=communityLevel2Tests.xml -Dshare.url=${SHARE_URL} -Dalfresco.url=${ALFRESCO_URL} ${WEBDRIVER_ARGUMENTS}

    - name: "Enterprise UI Tests"
      stage: Tests
      addons:
        firefox: "43.0.1"
        artifacts:
          paths:
            - ./rm-automation/rm-automation-ui/target/surefire-reports
            - ./rm-automation/rm-automation-ui/target/reports
            - ./rm-automation/rm-automation-ui/target/screenshots
          target_paths: $TRAVIS_BUILD_NUMBER
      script:
        - travis_retry travis_wait 90 mvn -B install -Dmaven.javadoc.skip=true -Dmaven.source.skip=true -DskipTests -q
        - travis_wait 5 bash scripts/downloadInstaller.sh $AUTOMATION_UI_PATH/target
        - travis_wait 20 mvn -B install -PinstallAlfresco,apply-rm-enterprise -q -f $AUTOMATION_UI_PATH/pom.xml
        - travis_wait 60 mvn -B install -Prun-alfresco -Dskip.automationtests=false -f $AUTOMATION_UI_PATH/pom.xml -DsuiteXmlFile=$TEST_SUITE -Dshare.url=${SHARE_URL} -Dalfresco.url=${ALFRESCO_URL} ${WEBDRIVER_ARGUMENTS}

#    - name: "Enterprise Classification Level 2 UI Tests"
#      stage: Tests
#      addons:
#        firefox: "43.0.1"
#        artifacts:
#          paths:
#            - ./rm-automation/rm-automation-ui/target/surefire-reports
#            - ./rm-automation/rm-automation-ui/target/reports
#            - ./rm-automation/rm-automation-ui/target/screenshots
#          target_paths: $TRAVIS_BUILD_NUMBER
#      before_install:
#        - travis_retry travis_wait 90 mvn -B install -Dmaven.javadoc.skip=true -Dmaven.source.skip=true -DskipTests -q
#        - travis_wait 5 bash scripts/downloadInstaller.sh $AUTOMATION_UI_PATH/target
#      install: travis_wait 20 mvn -B install -PinstallAlfresco,apply-rm-enterprise -q -f $AUTOMATION_UI_PATH/pom.xml
#      script:
#        - travis_wait 60 mvn -B install -Prun-alfresco -Dskip.automationtests=false -f $AUTOMATION_UI_PATH/pom.xml -DsuiteXmlFile=enterpriseLevel2ClassificationTests.xml -Dshare.url=${SHARE_URL} -Dalfresco.url=${ALFRESCO_URL} ${WEBDRIVER_ARGUMENTS}

#    - name: "Enterprise Classification UI Tests"
#      stage: Tests
#      addons:
#        firefox: "43.0.1"
#        artifacts:
#          paths:
#            - ./rm-automation/rm-automation-ui/target/surefire-reports
#            - ./rm-automation/rm-automation-ui/target/reports
#            - ./rm-automation/rm-automation-ui/target/screenshots
#          target_paths: $TRAVIS_BUILD_NUMBER
#      before_install:
#        - travis_retry travis_wait 90 mvn -B install -Dmaven.javadoc.skip=true -Dmaven.source.skip=true -DskipTests -q
#        - travis_wait 5 bash scripts/downloadInstaller.sh $AUTOMATION_UI_PATH/target
#      install: travis_wait 20 mvn -B install -PinstallAlfresco,apply-rm-enterprise -q -f $AUTOMATION_UI_PATH/pom.xml
#      script:
#        - travis_wait 60 mvn -B install -Prun-alfresco -Dskip.automationtests=false -f $AUTOMATION_UI_PATH/pom.xml -DsuiteXmlFile=enterpriseClassificationTests.xml -Dshare.url=${SHARE_URL} -Dalfresco.url=${ALFRESCO_URL} ${WEBDRIVER_ARGUMENTS}

#    - name: "Enterprise Guides UI Tests"
#      stage: Tests
#      addons:
#        firefox: "43.0.1"
#        artifacts:
#          paths:
#            - ./rm-automation/rm-automation-ui/target/surefire-reports
#            - ./rm-automation/rm-automation-ui/target/reports
#            - ./rm-automation/rm-automation-ui/target/screenshots
#          target_paths: $TRAVIS_BUILD_NUMBER
#      before_install:
#        - travis_retry travis_wait 90 mvn -B install -Dmaven.javadoc.skip=true -Dmaven.source.skip=true -DskipTests -q
#        - travis_wait 5 bash scripts/downloadInstaller.sh $AUTOMATION_UI_PATH/target
#      install: travis_wait 20 mvn -B install -PinstallAlfresco,apply-rm-enterprise -q -f $AUTOMATION_UI_PATH/pom.xml
#      script:
#        - travis_wait 60 mvn -B install -Prun-alfresco -Dskip.automationtests=false -f $AUTOMATION_UI_PATH/pom.xml -DsuiteXmlFile=enterpriseGuidesTests.xml -Dshare.url=${SHARE_URL} -Dalfresco.url=${ALFRESCO_URL} ${WEBDRIVER_ARGUMENTS}

#    - name: "Enterprise Security Marks UI Tests"
#      stage: Tests
#      addons:
#        firefox: "43.0.1"
#        artifacts:
#          paths:
#            - ./rm-automation/rm-automation-ui/target/surefire-reports
#            - ./rm-automation/rm-automation-ui/target/reports
#            - ./rm-automation/rm-automation-ui/target/screenshots
#          target_paths: $TRAVIS_BUILD_NUMBER
#      before_install:
#        - travis_retry travis_wait 90 mvn -B install -Dmaven.javadoc.skip=true -Dmaven.source.skip=true -DskipTests -q
#        - travis_wait 5 bash scripts/downloadInstaller.sh $AUTOMATION_UI_PATH/target
#      install: travis_wait 20 mvn -B install -PinstallAlfresco,apply-rm-enterprise -q -f $AUTOMATION_UI_PATH/pom.xml
#      script:
#        - travis_wait 60 mvn -B install -Prun-alfresco -Dskip.automationtests=false -f $AUTOMATION_UI_PATH/pom.xml -DsuiteXmlFile=enterpriseSecurityMarksTests.xml -Dshare.url=${SHARE_URL} -Dalfresco.url=${ALFRESCO_URL} ${WEBDRIVER_ARGUMENTS}
#
#    - name: "Enterprise Console and Configuration UI Tests"
#      stage: Tests
#      addons:
#        firefox: "43.0.1"
#        artifacts:
#          paths:
#            - ./rm-automation/rm-automation-ui/target/surefire-reports
#            - ./rm-automation/rm-automation-ui/target/reports
#            - ./rm-automation/rm-automation-ui/target/screenshots
#          target_paths: $TRAVIS_BUILD_NUMBER
#      before_install:
#        - travis_retry travis_wait 90 mvn -B install -Dmaven.javadoc.skip=true -Dmaven.source.skip=true -DskipTests -q
#        - travis_wait 5 bash scripts/downloadInstaller.sh $AUTOMATION_UI_PATH/target
#      install: travis_wait 20 mvn -B install -PinstallAlfresco,apply-rm-enterprise -q -f $AUTOMATION_UI_PATH/pom.xml
#      script:
#        - travis_wait 60 mvn -B install -Prun-alfresco -Dskip.automationtests=false -f $AUTOMATION_UI_PATH/pom.xml -DsuiteXmlFile=enterpriseConsoleAndConfigurationTests.xml -Dshare.url=${SHARE_URL} -Dalfresco.url=${ALFRESCO_URL} ${WEBDRIVER_ARGUMENTS}

    - name: "Source Clear Scan (SCA)"
      stage: Security Scans
      env: # no environment variables - overwrite with empty
      script:
       - echo "Source Clear Scan (SCA)"
    - name: "Static Analysis (SAST)"
      stage: Security Scans
      env: # no environment variables - overwrite with empty
      script:
       - echo "Static Analysis (SAST)"

    - name: "Community Release"
      stage: Release
      env: # no environment variables - overwrite with empty
      script:
        - echo "Community Release"
    - name: "Enterprise Release"
      stage: Release
      env: # no environment variables - overwrite with empty
      script:
        - echo "Enterprise Release"

    - name: "Copy to S3 Release Bucket"
      stage: Publish
      env: # no environment variables - overwrite with empty
      script:
        - echo "Copy to S3 Release Bucket"
