os: linux
dist: xenial
sudo: false
language: java
jdk:
  - openjdk8

branches:
  only:
    - /release\/V2.7.*/
    - /feature-2.7\/.*/
    - /merge-2.7\/.*/
    - /hotfix-2.7\/.*/

cache:
  directories:
    - $HOME/.m2

# the cache can grow constantly
before_cache:
  - rm -rf $HOME/.m2/repository/org/alfresco/alfresco-rm*

before_install:
  - "cp .travis.settings.xml $HOME/.m2/settings.xml"
install: true

stages:
  - name: Build AGS
  - name: Tests
    if: commit_message !~ /\[skip tests\]/
  - name: Security Scans
  - name: Release
  - name: Publish

jobs:
  include:
      - name: "Build AGS Community"
        stage: Build AGS
        before_install: source scripts/setUpMavenPhase.sh
        install:
          - echo  "Maven phase" ${MAVEN_PHASE}  $MAVEN_PHASE
          - travis_wait 60 mvn ${MAVEN_PHASE} -B -Dskip.integrationtests=false -Dcommunity -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn

      - name: "Build AGS Enterprise"
        stage: Build AGS
        before_install: bash scripts/setUpMavenPhase.sh
        install:
          - echo  "Maven phase" ${MAVEN_PHASE}  $MAVEN_PHASE
          - travis_wait 60 mvn ${MAVEN_PHASE} -B -Dskip.integrationtests=false -f rm-enterprise/pom.xml -am -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn

      - name: "AGS Benchmark"
        stage: Build AGS
        before_install: bash scripts/setUpMavenPhase.sh
        install:
          - echo "Maven phase" ${MAVEN_PHASE}  $MAVEN_PHASE
          - travis_wait 60 mvn ${MAVEN_PHASE} -B -Dskip.integrationtests=false -f rm-enterprise/pom.xml -am -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn


      - name: "Community Integrations Tests on MySQL"
        stage: Tests
      - name: "Enterprise Integrations Tests on MySQL"
      - name: "Community Rest API Tests"
      - name: "Enterprise Rest API Tests"
      - name: "Community UI Tests ..."
      - name: "Enterprise UI Tests ..."

        stage: Security Scans
      - name: "Source Clear Scan (SCA)"
      - name: "Static Analysis (SAST)"

        stage: Release
      - name: "Community Release"
      - name: "Enterprise Release"

        stage: Publish
      - name: "Copy to S3 Release Bucket"

