os: linux
dist: xenial
language: java
jdk:
  - openjdk8

branches:
  only:
    - /release\/V2.7.*/
    - /feature-2.7\/.*/
    - /merge-2.7\/.*/
    - /hotfix-2.7\/.*/

env:
  global:
    - AUTOMATION_COMMUNITY_PATH=rm-automation/rm-automation-community-rest-api
    - AUTOMATION_ENTERPRISE_PATH=rm-automation/rm-automation-enterprise-rest-api
    - AUTOMATION_UI_PATH=rm-automation/rm-automation-ui

cache:
  directories:
    - $HOME/.m2
# the cache can grow constantly
before_cache:
  - rm -rf $HOME/.m2/repository/org/alfresco/alfresco-rm*

before_install:
  - "cp .travis.settings.xml $HOME/.m2/settings.xml"
install: skip

services:
  - docker

stages:
  - name: Build AGS
  - name: Tests
    if: commit_message !~ /\[skip tests\]/
  - name: Security Scans
  - name: Release
  - name: Publish

jobs:
  include:
    - name: "Build Community"
      stage: Build AGS
      script:
        - echo "Build Community"
    - name: "Build Enterprise"
      stage: Build AGS
      script:
        - echo "Build Enterprise"
    - name: "Benchmark"
      stage: Build AGS
      script:
        - echo "Benchmark"

    - name: "Community Integrations Tests on MySQL"
      stage: Tests
      script:
        - echo "Community Integrations Tests on MySQL"
    - name: "Enterprise Integrations Tests on MySQL"
      stage: Tests
      script:
        - echo "Enterprise Integrations Tests on MySQL"
    - name: "Community Rest API Tests"
      stage: Tests
      before_install:
        - travis_retry travis_wait 90 mvn -B install -Dmaven.javadoc.skip=true -Dmaven.source.skip=true -DskipTests -q
        - travis_wait 5 bash scripts/downloadInstaller.sh $AUTOMATION_COMMUNITY_PATH/target
      install: travis_wait 15 mvn install -Pinstall-alfresco,apply-rm-community -q -f $AUTOMATION_COMMUNITY_PATH/pom.xml
      script:
        - curl --output /dev/null --silent --head --fail http://localhost:8080/alfresco
    - name: "Enterprise Rest API Tests"
      stage: Tests
      before_install:
        - travis_retry travis_wait 90 mvn -B install -Dmaven.javadoc.skip=true -Dmaven.source.skip=true -DskipTests -q
        - travis_wait 5 bash scripts/downloadInstaller.sh $AUTOMATION_ENTERPRISE_PATH/target
      install: travis_wait 15 mvn install -Pinstall-alfresco,apply-rm-enterprise -q -f $AUTOMATION_ENTERPRISE_PATH/pom.xml
      script:
        - curl --output /dev/null --silent --head --fail http://localhost:8080/alfresco
    - name: "Community UI Tests ..."
      stage: Tests
      before_install:
        - travis_retry travis_wait 90 mvn -B install -Dmaven.javadoc.skip=true -Dmaven.source.skip=true -DskipTests -q
        - travis_wait 5 bash scripts/downloadInstaller.sh $AUTOMATION_UI_PATH/target
      install: travis_wait 15 mvn install -Pinstall-alfresco,apply-rm-community -q -f $AUTOMATION_UI_PATH/pom.xml
      script:
        - curl --output /dev/null --silent --head --fail http://localhost:8080/alfresco
    - name: "Enterprise UI Tests ..."
      stage: Tests
      before_install:
        - travis_retry travis_wait 90 mvn -B install -Dmaven.javadoc.skip=true -Dmaven.source.skip=true -DskipTests -q
        - travis_wait 5 bash scripts/downloadInstaller.sh $AUTOMATION_UI_PATH/target
      install: travis_wait 15 mvn install -Pinstall-alfresco,apply-rm-enterprise -q -f $AUTOMATION_UI_PATH/pom.xml
      script:
        - curl --output /dev/null --silent --head --fail http://localhost:8080/alfresco

    - name: "Source Clear Scan (SCA)"
      stage: Security Scans
      script:
       - echo "Source Clear Scan (SCA)"
    - name: "Static Analysis (SAST)"
      stage: Security Scans
      script:
       - echo "Static Analysis (SAST)"

    - name: "Community Release"
      stage: Release
      script:
        - echo "Community Release"
    - name: "Enterprise Release"
      stage: Release
      script:
        - echo "Enterprise Release"

    - name: "Copy to S3 Release Bucket"
      stage: Publish
      script:
        - echo "Copy to S3 Release Bucket"
