<?xml version="1.0" encoding="UTF-8"?>

<process-definition xmlns="urn:jbpm.org:jpdl-3.1" name="wf:invite">

   <swimlane name="initiator"/>
   
   <swimlane name="assignee"/>

   <start-state name="start">
      <task name="wf:inviteToSiteTask" swimlane="initiator" />
      <transition name="sendInvite" to="invitePending">
         <action class="org.alfresco.repo.workflow.jbpm.AlfrescoJavaScript">
            <script>
               var workflowId = workflowinstanceid;
               var inviterPerson = people.getPerson(wf_inviterUserName);
               var inviteePerson = people.getPerson(wf_inviteeUserName);
               var site = siteService.getSite(wf_siteShortName);
               var siteName = site.shortName;
               if (site.title.length() > 0)
               {
                  siteName = site.title;
               }
               var params = "?inviteId=" + workflowId +
                            "&amp;inviteeUserName=" + wf_inviteeUserName +
                            "&amp;siteShortName=" + wf_siteShortName +
                            "&amp;inviteTicket=" + wf_inviteTicket;
               var acceptLink = wf_serverPath + wf_acceptUrl + params;
               var rejectLink = wf_serverPath + wf_rejectUrl + params;
               var mail = actions.create("mail");
               mail.parameters.from = inviterPerson.properties["cm:email"];
               mail.parameters.to = inviteePerson.properties["cm:email"];
               mail.parameters.subject = "Invitation to join '" + siteName + "' site";

               var template = companyhome.childByNamePath("Data Dictionary/Email Templates/invite/invite-email.ftl");
               var args = [];
               args["inviteePersonRef"] = inviteePerson.nodeRef.toString();
               args["inviterPersonRef"] = inviterPerson.nodeRef.toString();
               args["siteName"] = siteName;
               args["inviteeSiteRole"] = wf_inviteeSiteRole;
               args["inviteeUserName"] = wf_inviteeUserName;
               args["inviteeGenPassword"] = wf_inviteeGenPassword;
               args["acceptLink"] = acceptLink;
               args["rejectLink"] = rejectLink;
               var mail_text = inviteePerson.processTemplate(template, args);
                             
               mail.parameters.text = mail_text;
               mail.execute(bpm_package);
            </script>
         </action>
      </transition>
   </start-state>

   <task-node name="invitePending">
      <task name="wf:invitePendingTask" swimlane="assignee" />
      <transition name="accept" to="inviteAccepted" />
      <transition name="reject" to="inviteRejected" />
   </task-node>

   <task-node name="inviteAccepted">
      <task name="wf:acceptInviteTask" swimlane="assignee" />
      <!-- TODO glen.johnson - code in acceptInvite(...) method of inviteresponse web script -->
      <!-- needs to be moved into action for transition "end" below.                         -->
      <transition name="end" to="end" />
   </task-node>

   <task-node name="inviteRejected">
      <task name="wf:rejectInviteTask" swimlane="assignee" />
      <!-- TODO glen.johnson - code in rejectInvite(...) method of inviteresponse web script -->
      <!-- needs to be moved into action for transition "end" below.                         -->
      <transition name="end" to="end" />
   </task-node>

   <end-state name="end" />

</process-definition>
