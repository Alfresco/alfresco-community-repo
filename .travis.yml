---
import:
  - source: travis/.travis.env-vars.yml
  - source: travis/.travis.tests-stage.yml
  - source: travis/.travis.integration-test-MySQL.yml
  - source: travis/.travis.deploy-stage.yml
  - source: travis/.travis.release-stage.yml
  - source: travis/.travis.publish-stage.yml
dist: xenial
sudo: required
language: java
jdk: openjdk11

services:
  - docker

git:
  depth: false
  quiet: true

branches:
  only:
    - /release\/V3.\d+.*/
    - /feature-3.\d+\/.*/
    - /merge-3.\d+\/.*/
    - /hotfix-3.\d+\/.*/

cache:
  directories:
    - ${HOME}/.m2/repository

before_cache: rm -rf ${HOME}/.m2/repository/org/alfresco/alfresco-governance-services*

before_install:
  - mkdir -p "${HOME}/.m2" && cp -f .travis.settings.xml "${HOME}/.m2/settings.xml"
  - find "${HOME}/.m2/repository/" -type d -name "*-SNAPSHOT*" | xargs -r -l rm -rf
  - echo "${DOCKERHUB_PASSWORD}" | docker login -u="${DOCKERHUB_USERNAME}" --password-stdin
  - echo "${QUAY_PASSWORD}" | docker login -u="${QUAY_USERNAME}" --password-stdin quay.io

install: skip

stages:
  - name: Tests
    if: commit_message !~ /\[skip tests\]/
  - name: Deploy
    if: fork = false AND (branch = master OR branch =~ /release\/.*/) AND type != pull_request
  - name: Release
    if: fork = false AND (branch = master OR branch =~ /release\/.*/) AND type != pull_request AND commit_message =~ /\[(community|enterprise) release .*\]/
  - name: Publish
    if: fork = false AND (branch = master OR branch =~ /release\/.*/) AND type != pull_request AND commit_message =~ /\[publish\]/
